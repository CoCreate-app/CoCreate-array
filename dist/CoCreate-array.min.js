/* CoCreateJS */
var arrayClass="arrayField";function initSocketsForArray(){CoCreateSocket.listen("connect",function(t,e){console.log("socket connected"),e==CoCreateSocket.getGlobalScope()&&socketConnectedForArray()}),CoCreateSocket.listen("createDocument",function(t){insertCreatedIdToArray(t)}),CoCreateSocket.listen("getDocument",function(t){fetchedDataForArray(t)}),CoCreateSocket.listen("updateDocument",function(t){fetchedDataForArray(t)})}function initArrayForms(){for(var t=document.querySelectorAll("form"),e=0;e<t.length;e++){initArrayTags(t[e])}}function initArrayTags(t){for(var e=t.querySelectorAll("[data-array_name]"),a=0;a<e.length;a++){initArrayTag(t,e[a])}}function initArrayTag(t,e){var a=t.getAttribute("data-realtime"),r=t.getAttribute("data-collection")?t.getAttribute("data-collection"):"module_activity";if("false"!=a&&(e.addEventListener("change",function(a){a.preventDefault();var o=this.getAttribute("data-array_name"),n=getArrayValue(t,e),c=r==this.getAttribute("data-document_id");c&&CoCreate.updateDocument({collection:r,document_id:c,data:{[o]:n},metadata:""})}),"SELECT"!=e.tagName))for(var o=e.querySelectorAll('input[type="checkbox"]'),n=0;n<o.length;n++){o[n].addEventListener("change",function(t){t.preventDefault()})}}function socketConnectedForArray(){fetchArrays()}function insertCreatedIdToArray(t){var e=t.element,a=document.querySelector("form[data-form_id='"+e+"']");if(a){var r=a.getElementsByClassName("arrayField"),o=a.getAttribute("data-collection");o=o||"module_activity";for(var n=0;n<r.length;n++){var c=r[n];c.getAttribute("data-document_id")||c.setAttribute("data-document_id",t.document_id)}}}function getArrayValue(t,e){var a=[];if("SELECT"==e.tagName){var r=e.value;a.push(r)}else for(var o=e.querySelectorAll('input[type="checkbox"]'),n=0;n<o.length;n++){var c=o[n];if(c.checked){r=c.value;a.push(r)}}return console.log(a),a}function updateArray(t){for(var e=t.getAttribute("data-collection")||"module_activity",a=t.querySelectorAll("[data-array_name]"),r=0;r<a.length;r++){var o=a[r],n=o.getAttribute("data-array_name"),c=getArrayValue(t,o),i=o.getAttribute("data-document_id");i&&CoCreate.updateDocument({collection:e,document_id:i,data:{[n]:c},metadata:""})}}function fetchedDataForArray(t){for(var e=t.collection,a=document.querySelectorAll("form"),r=0;r<a.length;r++){var o=a[r];if((o.getAttribute("data-collection")?o.getAttribute("data-collection"):"module_activity")==e)for(var n=o.querySelectorAll("[data-array_name]"),c=0;c<n.length;c++){var i=n[c];i.getAttribute("data-document_id")===t.document_id&&updateArrayData(i,t.data)}}}function updateArrayData(t,e){var a=t.getAttribute("data-array_name");if(a in e){var r=e[a];if("SELECT"==t.tagName)r.length>0?t.value=r[0]:t.value=null;else for(var o=t.querySelectorAll('input[type="checkbox"]'),n=0;n<o.length;n++){var c=o[n];r.indexOf(c.value)>-1?c.checked=!0:c.checked=!1}}}function fetchArrays(){for(var t=[],e=document.querySelectorAll("form"),a=0;a<e.length;a++)for(var r=e[a],o=r.getAttribute("data-collection")?r.getAttribute("data-collection"):"module_activity",n=r.querySelectorAll("[data-array_name]"),c=0;c<n.length;c++){var i=n[c].getAttribute("data-document_id");if(i){for(var l=!1,u=0;u<t.length;u++)o!=t[u]["data-collection"]||i!=t[u].id||(l=!0);l||t.push({"data-collection":o,id:i})}}t.forEach(t=>{CoCreate.getDocument({collection:t["data-collection"],document_id:t.id,metadata:""})})}initSocketsForArray(),initArrayForms();